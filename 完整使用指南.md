# 文档一致性检查系统 - 完整使用指南

## 系统概述

这是一个智能文档生成和一致性管理系统，用户可以：
1. 生成多份文档
2. 修改某个文档的某个点
3. **自动检查其他文档是否需要同步修改**
4. 预览修改前后的Diff对比

---

## 架构图

```
┌─────────────────────────────────────────┐
│  用户上传多个文档（MinIO URLs）        │
│  → 批量添加到知识库                     │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  用户选择某个文档进行编辑               │
│  → 设置修改点和修改要求                 │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  系统调用RAG检索相关文档                │
│  → http://localhost:1234/search         │
│  → metadata_filter: {content_type...}   │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  提取涉及的file_path（MinIO URLs）     │
│  → 从MinIO读取完整文件内容              │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  AI分析哪些文档需要同步修改             │
│  → 生成每个文档的修改建议               │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  前端显示Diff对比                       │
│  → 用户可查看并应用修改                 │
└─────────────────────────────────────────┘
```

---

## 使用流程

### 步骤1: 启动服务

```bash
# 后端服务
cd Writer
python run.py

# 前端服务（如果需要独立开发）
cd frontend
npm run dev
```

访问: `http://localhost:8000`

---

### 步骤2: 上传文档到知识库

#### 前端操作：

1. 打开"一致性检查"标签页
2. 设置Project ID（例如：`test202511241125`）
3. 添加MinIO URL：
   ```
   http://43.139.19.144:9000/gauz-documents/documents/论文1.md
   http://43.139.19.144:9000/gauz-documents/documents/论文2.md
   http://43.139.19.144:9000/gauz-documents/documents/论文3.md
   ```
4. 点击"上传到知识库"

#### API调用（可选）：

```bash
curl -X POST http://localhost:8000/batch-upload-to-kb \
  -H "Content-Type: application/json" \
  -d '{
    "minio_urls": [
      "http://43.139.19.144:9000/.../论文1.md",
      "http://43.139.19.144:9000/.../论文2.md"
    ],
    "project_id": "test202511241125",
    "enable_vlm": false
  }'
```

**后台发生了什么？**
```
系统 → POST http://localhost:8001/api/v1/process_and_extract
     → 每个MinIO URL都被处理并添加到知识库
     → 自动切分为chunks（content_type: file_chunk）
```

---

### 步骤3: 选择文档并设置修改

1. **选择要编辑的文档**：从下拉列表选择
2. **查看文档内容**：系统会从MinIO读取并显示
3. **设置修改点**（用于RAG检索）：
   - 例如：`早季分类`、`LSTM模型`、`2022年数据`
4. **设置修改要求**：
   - 例如：`将所有LSTM模型改为Transformer模型，包括模型描述、参数配置、实验结果`

---

### 步骤4: 执行一致性检查

点击"检查文档一致性"按钮，系统会：

1. **RAG检索**：
   ```json
   POST http://localhost:1234/search
   {
     "query": "早季分类",
     "project_id": "test202511241125",
     "top_k": 10,
     "use_refine": false,
     "metadata_filter": {
       "content_type": "file_chunk"
     }
   }
   ```

2. **提取相关文档**：
   - 从RAG返回的bundles中提取`metadata.minio_url`
   - 得到相关文档列表（如：论文2.md, 论文3.md）

3. **读取完整文件**：
   - 对每个MinIO URL，发送GET请求读取完整内容

4. **AI分析**：
   - 判断哪些文档需要修改
   - 生成修改类型和策略

5. **生成修改建议**：
   - 为每个需要修改的文档生成新版本
   - 计算diff

---

### 步骤5: 查看和应用修改

#### 前端显示：

**AI分析结果**：
- 修改类型：模型替换
- 全局一致性：需要
- 分析说明：这些文档都使用了LSTM模型，需要统一改为Transformer以保持一致性

**相关文档列表**：
- 论文2.md（召回3个相关片段）
- 论文3.md（召回5个相关片段）

**修改建议**：
| 文档 | 变化 | 操作 |
|------|------|------|
| 论文2.md | 行数变化: +12，原150行 → 新162行 | [查看Diff] |
| 论文3.md | 行数变化: +8，原200行 → 新208行 | [查看Diff] |

#### Diff对比：

点击"查看Diff"，Monaco Diff Editor会显示：
- 左侧：原始内容
- 右侧：修改后内容
- 高亮：变化部分

---

## API接口说明

### 1. 上传文件到知识库

**端点**: `POST /upload-to-kb`

**单个文件**：
```json
{
  "minio_url": "http://43.139.19.144:9000/.../file.md",
  "project_id": "test202511241125",
  "enable_vlm": false
}
```

**批量上传**: `POST /batch-upload-to-kb`
```json
{
  "minio_urls": ["url1", "url2", "url3"],
  "project_id": "test202511241125",
  "enable_vlm": false
}
```

---

### 2. 一致性检查

**端点**: `POST /check-consistency`

**请求**：
```json
{
  "modification_point": "早季分类",
  "modification_request": "将LSTM改为Transformer",
  "project_id": "test202511241125",
  "current_file": "http://43.139.19.144:9000/.../论文1.md",
  "current_file_content": "...",
  "top_k": 10
}
```

**响应**：
```json
{
  "success": true,
  "related_files": {
    "http://.../论文2.md": [
      {
        "content": "...chunk content...",
        "score": 0.89,
        "metadata": {...}
      }
    ]
  },
  "consistency_analysis": {
    "needs_modification": ["论文2.md", "论文3.md"],
    "modification_type": "模型替换",
    "global_consistency_required": true
  },
  "modifications": [
    {
      "file_path": "http://.../论文2.md",
      "original_content": "...",
      "modified_content": "...",
      "diff_summary": "行数变化: +12"
    }
  ]
}
```

---

## 配置说明

### 环境变量 (.env)

```bash
# OpenRouter API（用于AI分析和修改）
OPENROUTER_API_KEY=sk-or-v1-xxxxx
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
MODEL_NAME=x-ai/grok-4.1-fast:free

# RAG配置（在rag_tool.py中硬编码）
# 搜索接口: http://localhost:1234/search
# 处理接口: http://localhost:8001/api/v1/process_and_extract
```

---

## 典型使用场景

### 场景1: 论文术语统一

**背景**：生成了3篇论文，都使用"LSTM"模型，现在要统一改为"Transformer"

**操作**：
1. 上传3篇论文到知识库
2. 选择论文1，设置：
   - 修改点：`LSTM模型`
   - 修改要求：`将LSTM改为Transformer，包括原理说明、参数配置、实验结果`
3. 执行一致性检查
4. 系统自动发现论文2和论文3也需要修改
5. 查看每个文档的diff并应用

---

### 场景2: 数据年份更新

**背景**：多篇报告引用2022年数据，需要更新到2024年

**操作**：
1. 上传所有报告
2. 选择某一份报告，设置：
   - 修改点：`2022年数据`
   - 修改要求：`将所有2022年的统计数据、时间点、引用更新为2024年`
3. 系统找出所有相关报告并生成修改建议

---

### 场景3: 实验方法改进

**背景**：多篇论文使用相同实验设置，现在要改进某个参数

**操作**：
1. 修改点：`学习率参数`
2. 修改要求：`将学习率从0.001改为0.0001，并更新相关说明`
3. 系统确保所有使用该参数的论文都被同步修改

---

## 技术细节

### RAG检索流程

```python
# 1. 构建请求
request = {
    "query": "早季分类",
    "project_id": "test202511241125",
    "top_k": 10,
    "use_refine": false,
    "metadata_filter": {
        "content_type": "file_chunk"
    }
}

# 2. 调用RAG
response = requests.post("http://localhost:1234/search", json=request)

# 3. 解析结果
bundles = response.json()["bundles"]
for bundle in bundles:
    minio_url = bundle["metadata"]["minio_url"]
    content = bundle["content"]
    score = bundle["score"]
```

### 文件读取流程

```python
# 从MinIO读取
async def read_from_minio(minio_url):
    async with httpx.AsyncClient() as client:
        response = await client.get(minio_url)
        return response.text
```

---

## 注意事项

1. **MinIO URL格式**：确保URL可公开访问
2. **项目ID一致**：上传和检索使用相同的project_id
3. **文件格式**：当前仅支持Markdown（.md）
4. **大文件处理**：超长文档可能需要更长处理时间
5. **并发修改**：避免多用户同时修改同一项目

---

## 故障排查

### 问题1: 上传失败

**检查**：
- 知识库服务是否运行（localhost:8001）
- MinIO URL是否可访问
- 网络连接是否正常

### 问题2: RAG检索无结果

**检查**：
- 文档是否已成功上传到知识库
- project_id是否正确
- metadata_filter是否正确设置

### 问题3: 修改生成失败

**检查**：
- OpenRouter API key是否有效
- 模型配额是否充足
- 网络连接是否稳定

---

## 后续优化建议

1. **版本控制**：集成Git，自动创建分支
2. **批量应用**：一键应用所有修改
3. **修改历史**：记录所有一致性修改
4. **智能触发**：自动检测重要修改
5. **协作编辑**：多用户实时协作

---

## 联系与支持

如有问题，请查看日志文件或联系开发团队。

