# 文档一致性检查系统 - 使用说明（RAG版本）

## 🎯 系统概述

基于RAG（检索增强生成）的全局文档一致性分析系统，可以：

1. **上传文档到知识库**：自动分块、向量化、建立索引
2. **RAG全局检索**：在整个项目中智能检索相关文档
3. **AI一致性分析**：分析跨文档的一致性需求
4. **自动生成修改**：为所有相关文档生成一致性修改建议
5. **Monaco Diff展示**：可视化对比修改前后的差异

## 📋 完整工作流程

### 步骤 1: 上传文档到知识库

**前端操作**：
1. 输入 Project ID（例如：`test202511241125`）
2. 添加多个 MinIO URL（Markdown文件）
3. 点击"上传X个文档到知识库"

**后端处理**：
```
前端 → POST /api/batch-upload-to-kb
     → 后端 → POST localhost:8001/api/v1/process_and_extract (逐个上传)
     → 知识库服务：
        - 下载MinIO文件
        - 按H1标题分块
        - 生成向量嵌入
        - 存入向量数据库
```

**示例请求**：
```json
POST /api/batch-upload-to-kb
{
  "minio_urls": [
    "http://43.139.19.144:9000/gauz-documents/documents/.../paper1.md",
    "http://43.139.19.144:9000/gauz-documents/documents/.../paper2.md",
    "http://43.139.19.144:9000/gauz-documents/documents/.../paper3.md"
  ],
  "project_id": "test202511241125",
  "enable_vlm": false
}
```

---

### 步骤 2: 设置一致性检查

**前端操作**：
1. 输入**修改点**（关键词）
   - 例如：`LSTM模型`、`早季分类`、`2022年数据`
2. 输入**修改要求**（详细说明）
   - 例如：`将所有LSTM模型改为Transformer模型，包括模型架构描述、参数配置、训练过程和实验结果`
3. 设置**Top-K**（召回数量，默认15）
4. 点击"开始一致性检查（RAG全局检索）"

---

### 步骤 3: RAG检索相关文档

**后端自动处理**：

```python
# 1. 调用RAG检索
POST localhost:1234/search
{
  "query": "LSTM模型",
  "project_id": "test202511241125",
  "top_k": 15,
  "use_refine": false,
  "metadata_filter": {
    "content_type": "file_chunk"
  }
}

# 2. RAG返回结果示例
{
  "bundles": [
    {
      "content": "...LSTM模型的架构...",
      "score": 0.95,
      "metadata": {
        "minio_url": "http://.../paper1.md",
        "content_type": "file_chunk"
      }
    },
    {
      "content": "...使用LSTM进行分类...",
      "score": 0.89,
      "metadata": {
        "minio_url": "http://.../paper2.md",
        "content_type": "file_chunk"
      }
    }
    // ... 更多结果
  ]
}

# 3. 按minio_url分组
related_files = {
  "http://.../paper1.md": [chunk1, chunk2, ...],
  "http://.../paper2.md": [chunk3, ...],
  "http://.../paper15.md": [chunk20, ...]
}
```

**结果**：可能召回 15 个相关文档（不局限于前端上传的3个）

---

### 步骤 4: 读取文档完整内容

**后端自动处理**：

```python
# 对每个召回的文档，从MinIO读取完整内容
for minio_url in related_files:
    content = await kb_manager.read_file_from_minio(minio_url)
    # 直接HTTP GET MinIO URL
    files_content[minio_url] = content
```

**为什么读取完整内容？**
- RAG只返回相关的**片段（chunks）**
- AI需要看到**完整文档**才能生成准确的修改
- 从MinIO直接读取，速度快

---

### 步骤 5: AI分析一致性

**后端调用LLM分析**：

```python
# Prompt示例
analysis_prompt = f"""
你需要分析以下修改是否影响其他文档的一致性。

修改要求: 将所有LSTM模型改为Transformer模型

当前文件内容预览: {first_file_content[:500]}

相关文档:
文件: paper2.md
内容预览: 本文使用LSTM模型进行早季分类...

文件: paper3.md
内容预览: 实验采用LSTM网络...

请分析:
1. 这个修改是否需要在其他文档中同步？
2. 哪些文档需要修改以保持一致性？
3. 修改类型是什么？

返回JSON:
{{
  "needs_modification": ["paper2.md", "paper3.md"],
  "modification_type": "模型架构统一",
  "consistency_analysis": "详细说明...",
  "global_consistency_required": true
}}
"""

# LLM返回分析结果
{
  "needs_modification": ["paper2.md", "paper3.md", "paper5.md"],
  "modification_type": "模型架构统一（LSTM → Transformer）",
  "consistency_analysis": "在学术论文中，模型选择需要保持一致性。如果主文档改用Transformer，其他相关论文中的模型描述、实验设置、性能对比都需要相应更新，以确保研究结论的有效性和可比性。",
  "global_consistency_required": true
}
```

---

### 步骤 6: 生成修改建议

**后端调用LLM生成修改**：

```python
# 为每个需要修改的文档
for file_path, original_content in files_to_modify.items():
    
    prompt = f"""
修改要求: {modification_request}

参考修改示例（保持一致的修改风格）:
{current_modification[:500]}...

待修改文件: {file_name}
文件内容:
{original_content}

要求:
1. 全局一致性：确保修改与其他文档保持一致
2. 完整性：找出所有需要修改的地方
3. 保持格式：保留原有的Markdown格式
4. 逻辑连贯：修改后内容逻辑自洽

直接返回修改后的完整文档内容。
"""
    
    # LLM生成修改后的完整文档
    modified_content = await llm.complete(prompt)
    
    modifications.append({
        "file_path": minio_url,
        "original_content": original_content,
        "modified_content": modified_content,
        "diff_summary": "行数变化: +5，原100行 → 新105行",
        "original_length": len(original_content),
        "modified_length": len(modified_content)
    })
```

---

### 步骤 7: Monaco Diff 展示

**前端渲染**：

```jsx
// 显示AI分析结果
<div className="analysis-card">
  <p>修改类型: 模型架构统一（LSTM → Transformer）</p>
  <p>全局一致性: 需要全局同步</p>
  <p>分析说明: 在学术论文中，模型选择需要保持一致性...</p>
</div>

// 显示相关文档列表
<div className="file-grid">
  {Object.entries(related_files).map(([filePath, chunks]) => (
    <div className="file-card">
      <div className="file-name">{filePath.split('/').pop()}</div>
      <div className="file-meta">召回 {chunks.length} 个相关片段</div>
    </div>
  ))}
</div>

// 显示修改建议
{modifications.map((mod, index) => (
  <div className="modification-card">
    <div className="mod-filename">{mod.file_path.split('/').pop()}</div>
    <div className="mod-summary">{mod.diff_summary}</div>
    <button onClick={() => handleViewDiff(mod)}>查看 Diff</button>
  </div>
))}

// Monaco Diff Editor（点击"查看Diff"后弹出）
<DiffEditor
  original={selectedDiff.original_content}
  modified={selectedDiff.modified_content}
  language="markdown"
  theme="vs-dark"
  options={{
    renderSideBySide: true,  // 左右对比
    readOnly: true
  }}
/>
```

---

## 🔧 API接口说明

### 1. 批量上传到知识库

```
POST /api/batch-upload-to-kb
```

**请求**：
```json
{
  "minio_urls": ["http://...", "http://..."],
  "project_id": "test202511241125",
  "enable_vlm": false
}
```

**响应**：
```json
{
  "success": true,
  "message": "上传完成: 3/3 成功",
  "success_count": 3,
  "total": 3,
  "results": [
    {
      "success": true,
      "minio_url": "http://...",
      "result": {...}
    }
  ]
}
```

### 2. RAG一致性检查

```
POST /api/check-consistency
```

**请求**：
```json
{
  "modification_point": "LSTM模型",
  "modification_request": "将所有LSTM模型改为Transformer模型，包括模型描述、参数配置、实验结果",
  "project_id": "test202511241125",
  "top_k": 15
}
```

**响应**：
```json
{
  "success": true,
  "modification_point": "LSTM模型",
  "consistency_analysis": {
    "modification_type": "模型架构统一",
    "global_consistency_required": true,
    "consistency_analysis": "详细说明..."
  },
  "related_files": {
    "http://.../paper1.md": [{"content": "...", "score": 0.95}],
    "http://.../paper2.md": [{"content": "...", "score": 0.89}]
  },
  "total_files": 15,
  "total_chunks": 42,
  "modifications": [
    {
      "file_path": "http://.../paper2.md",
      "original_content": "原始内容...",
      "modified_content": "修改后内容...",
      "diff_summary": "行数变化: +5，原100行 → 新105行",
      "original_length": 2340,
      "modified_length": 2456
    }
  ],
  "message": "成功分析 15 个文档，生成 12 个修改建议"
}
```

---

## 🎨 界面功能

### 步骤1区域
- Project ID输入框
- MinIO URL添加/删除
- 待上传文档列表
- "上传X个文档到知识库"按钮
- 上传状态提示

### 步骤2区域
- 修改点输入框（带提示）
- 修改要求文本域（多行）
- Top-K数量选择
- "开始一致性检查"按钮

### 步骤3区域（结果展示）
- **AI分析结果卡片**
  - 修改类型
  - 全局一致性标记
  - 详细分析说明

- **相关文档网格**
  - 文档名称
  - 召回片段数量
  - 悬停效果

- **修改建议列表**
  - 文档编号
  - 文件名
  - Diff摘要
  - 字符数变化
  - "查看Diff"按钮

- **Diff Modal**
  - Monaco Diff Editor（全屏）
  - 左侧：原始内容
  - 右侧：修改后内容
  - 差异高亮

---

## 🚀 使用示例

### 示例1：统一模型架构

**场景**：项目中有20篇论文，现在要把所有LSTM改成Transformer

1. 上传20个文档到知识库（Project ID: `nlp_papers`）
2. 设置检查：
   - 修改点：`LSTM模型`
   - 修改要求：`将所有LSTM模型改为Transformer模型，包括模型架构描述、参数配置、训练过程和实验结果`
   - Top-K：20
3. 系统自动：
   - RAG检索 → 召回15个提到LSTM的文档
   - 读取完整内容
   - AI分析 → 确认需要全局一致性修改
   - 生成15个文档的修改版本
4. 查看Diff → 确认修改正确
5. （可选）应用修改

### 示例2：更新实验数据

**场景**：将所有2022年数据更新为2023年数据

1. 上传文档到知识库
2. 设置检查：
   - 修改点：`2022年数据`
   - 修改要求：`将所有引用2022年数据的地方更新为2023年最新数据`
3. 系统召回所有提到2022年的文档
4. AI生成更新建议
5. 查看并应用

---

## ⚡ 技术优势

### 相比旧版本的改进

| 旧版本（本地模式） | 新版本（RAG模式） |
|---|---|
| ❌ 只检查前端加载的3个文档 | ✅ RAG检索整个项目（可能15+文档） |
| ❌ 简单文本匹配 | ✅ 语义检索（向量相似度） |
| ❌ 需要用户手动选择文档 | ✅ 自动发现所有相关文档 |
| ❌ 浪费知识库能力 | ✅ 充分利用RAG系统 |
| ❌ 不适合大项目 | ✅ 项目文档越多越有用 |

---

## 📝 注意事项

1. **知识库服务必须运行**
   - 地址：`localhost:8001`
   - 如果未运行，上传会失败

2. **RAG服务必须运行**
   - 地址：`localhost:1234`
   - 负责向量检索

3. **MinIO URL必须可访问**
   - 确保网络通畅
   - CORS配置正确

4. **Project ID要一致**
   - 上传和检查使用同一个Project ID
   - 否则检索不到文档

5. **Top-K设置合理**
   - 太小（<5）：可能遗漏相关文档
   - 太大（>30）：可能包含不相关文档
   - 推荐：10-20

6. **LLM Token限制**
   - 单个文档建议<50KB
   - 过大的文档可能超出LLM上下文

---

## 🔍 故障排除

### 问题1：上传失败
- 检查知识库服务是否运行：`curl localhost:8001`
- 查看后端日志：`logs/app_*.log`

### 问题2：检索不到文档
- 确认Project ID正确
- 确认文档已成功上传到知识库
- 尝试增大Top-K

### 问题3：Diff显示空白
- 检查浏览器控制台错误
- 确认Monaco Editor加载成功

---

## 🎯 下一步功能

- [ ] 支持批量应用修改
- [ ] 修改历史记录
- [ ] 导出修改报告
- [ ] 支持更多文件格式（PDF、DOCX）
- [ ] 并发优化（并行生成修改）

